<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Talon Market Viewer by Mr Patate</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
body {
font-family: 'Comic Sans MS', sans-serif;
background: #f0f8ff url('https://media.discordapp.net/attachments/1309336848514027551/1441587174305828864/Greysuitcase-RubberDuckProjectSeoul01.png?ex=6922562d&is=692104ad&hm=d93e6875462e13961480d108a52950df05e22375af5e917351fe959e5c912099&=&format=webp&quality=lossless') no-repeat center center;
background-size: cover; /* This stretches the image */
color: #333;
padding: 20px;
}


.card {
max-width: 700px;
margin: auto;
padding: 20px;
border-radius: 16px;
background: #fffde7ab; /* light yellow */
box-shadow: 0 2px 10px rgba(0,0,0,0.2);
border: 2px solid #fdd835; /* golden yellow */
}


input, select {
padding: 8px;
width: 100%;
margin-bottom: 12px;
border-radius: 8px;
border: 2px solid #fdd835;
background-color: #fff9c4;
box-sizing: border-box; /* ensures consistent width */
}


button {
padding: 10px 16px;
border: none;
background: #fbc02d;
color: #333;
border-radius: 10px;
cursor: pointer;
font-weight: bold;
}
    canvas { margin-top: 20px; }
    .stats { margin-top: 12px; font-weight: bold; }
    #fileContainer { display: none; margin-bottom: 12px; }
    .checkbox-label { display: flex; align-items: center; margin-bottom: 12px; cursor: pointer; gap: 6px;}
    .checkbox-label input { margin: 0; width: auto; }
    #stats { margin-top: 12px; font-weight: bold; color: #00a2ff;}
    #loading { display: none; margin-bottom: 12px; font-weight: bold; color: #006eff;}
    button:hover { background: #fdd835;}

  </style>
</head>
<body>
  <div class="card">
    <h2>Talon Market Viewer by Mr Patate</h2>
    <input id="itemInput" placeholder="Enter item name..." />
    <label class="checkbox-label"><input type="checkbox" id="importCheck" onchange="toggleFileInput()"> Import new data file</label>
    <div id="fileContainer">
      <input type="file" id="fileInput" accept=".csv" />
    </div>
    <select id="monthFilter">
      <option value="1">1 Month</option>
      <option value="3">3 Months</option>
      <option value="6">6 Months</option>
    </select>
    <button onclick="loadData()">Load History</button>
    <div id="loading">Loading data, please wait...</div>
    <canvas id="chart"></canvas>
    <div id="stats" class="stats"></div>
  </div>

  <script>
    let chart;

    function toggleFileInput() {
      const container = document.getElementById('fileContainer');
      container.style.display = document.getElementById('importCheck').checked ? 'block' : 'none';
    }

    function calculateStats(values) {
      const sorted = [...values].sort((a,b) => a-b);
      const min = sorted[0];
      const max = sorted[sorted.length-1];
      const sum = values.reduce((a,b) => a+b, 0);
      const avg = Math.round(sum / values.length);
      const mid = Math.floor(sorted.length/2);
      const median = sorted.length % 2 === 0 ? (sorted[mid-1]+sorted[mid])/2 : sorted[mid];
      return {min, max, avg, median};
    }

    function formatNumber(num) {
      return num.toLocaleString();
    }

    function filterByMonths(data, months) {
      const cutoff = new Date();
      cutoff.setMonth(cutoff.getMonth() - Number(months));
      return data.filter(row => new Date(row.date) >= cutoff);
    }

    async function loadData() {
      const loading = document.getElementById('loading');
      loading.style.display = 'block';

      try {
        const item = document.getElementById('itemInput').value.trim();
        if (!item) { loading.style.display = 'none'; return alert("Enter an item name"); }

        const importCheck = document.getElementById('importCheck').checked;
        let parsed;

        if (importCheck) {
          const fileInput = document.getElementById('fileInput');
          if (!fileInput.files.length) { loading.style.display = 'none'; return alert("Please select a CSV file to import."); }
          const file = fileInput.files[0];
          parsed = await new Promise(resolve => {
            Papa.parse(file, {
              header: true,
              complete: results => resolve(results)
            });
          });
        } else {
          try {
            const response = await fetch('Talon Market Master Vendor Data.csv');
            const csvText = await response.text();
            parsed = Papa.parse(csvText, { header: true });
          } catch (err) {
            console.error(err);
            loading.style.display = 'none';
            return alert("Could not load 'Talon Market Master Vendor Data.csv' from server root.");
          }
        }

        const monthFilter = document.getElementById('monthFilter').value;
        let data = parsed.data.filter(row => row["item name"] && row["item name"].toLowerCase() === item.toLowerCase());
        data = filterByMonths(data, monthFilter);

        if (!data.length) { loading.style.display = 'none'; return alert("No data found for that item and date range."); }

        const labels = data.map(e => e.date);
        const prices = data.map(e => Number(e.price));

        if (chart) chart.destroy();

        const ctx = document.getElementById('chart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{ label: item + ' Price', data: prices }]
          }
        });

        const stats = calculateStats(prices);
        document.getElementById('stats').innerHTML =
          `Min: ${formatNumber(stats.min)} | Max: ${formatNumber(stats.max)} | Avg: ${formatNumber(stats.avg)} | Median: ${formatNumber(stats.median)}`;
      } finally {
        loading.style.display = 'none';
      }
    }
  </script>
</body>
</html>
